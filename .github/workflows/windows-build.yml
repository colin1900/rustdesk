- name: Hardcode Fix UI Definitions
        shell: powershell
        run: |
          $tabbarPath = "flutter/lib/desktop/widgets/tabbar_widget.dart"
          
          # 重新构建整个文件，包含所有丢失的类定义
          $stub = @"
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';

// 补全丢失的关键类
class DesktopTabController {}
class TabInfo {}
enum DesktopTabType { remote, fileManager, portForward, terminal, camera }

class TabbarTheme extends ThemeExtension<TabbarTheme> {
  final Color selectedTabIconColor;
  final Color unSelectedTabIconColor;
  final Color selectedTextColor;
  final Color unSelectedTextColor;
  final Color selectedIconColor;
  final Color unSelectedIconColor;
  final Color dividerColor;
  final Color hoverColor;
  final Color closeHoverColor;
  final Color selectedTabBackgroundColor;

  TabbarTheme({
    this.selectedTabIconColor = Colors.blue,
    this.unSelectedTabIconColor = Colors.grey,
    this.selectedTextColor = Colors.black,
    this.unSelectedTextColor = Colors.black54,
    this.selectedIconColor = Colors.blue,
    this.unSelectedIconColor = Colors.grey,
    this.dividerColor = Colors.transparent,
    this.hoverColor = Colors.white12,
    this.closeHoverColor = Colors.red,
    this.selectedTabBackgroundColor = Colors.white,
  });

  @override
  TabbarTheme copyWith() => this;
  @override
  TabbarTheme lerp(ThemeExtension<TabbarTheme>? other, double t) => this;
}
"@
          # 使用 UTF8 编码写入，防止乱码导致编译器报错
          [System.IO.File]::WriteAllText($tabbarPath, $stub, [System.Text.Encoding]::UTF8)

          # 修复 DialogTheme/TabBarTheme 全局引用
          Get-ChildItem -Path "flutter/lib" -Recurse -Include *.dart | ForEach-Object {
              $t = Get-Content $_.FullName -Raw
              if ($t -match 'DialogTheme|TabBarTheme') {
                  $t = $t -replace 'DialogTheme\(', 'DialogThemeData(' `
                          -replace 'TabBarTheme\(', 'TabBarThemeData(' `
                          -replace 'DialogTheme\?', 'DialogThemeData?' `
                          -replace 'TabBarTheme\?', 'TabBarThemeData?'
                  [System.IO.File]::WriteAllText($_.FullName, $t, [System.Text.Encoding]::UTF8)
              }
          }

      - name: Fix Freezed and Build
        shell: powershell
        run: |
          cd flutter
          # 强制重新运行生成器，解决 EventToUI 丢失问题
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          cd ..
          
          $VcpkgInst = "C:\vcpkg\installed\x64-windows-static"
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I`"$VcpkgInst\include`" -I`"$env:UniversalCRTSdkDir\Include\$env:UCRTVersion\ucrt`" -I`"$env:UniversalCRTSdkDir\Include\$env:UCRTVersion\shared`" -I`"$env:VCToolsInstallDir\include`""
          
          # 执行 RustDesk 专用的构建脚本
          python build.py --flutter
          
          cd flutter
          flutter build windows --release --no-tree-shake-icons
