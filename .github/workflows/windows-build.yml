name: Build-Windows-Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Install Build Tools
        run: |
          choco install llvm nasm ninja -y
          pip install requests

      - name: Setup VCPKG
        shell: powershell
        run: |
          $VcpkgInst = "C:\vcpkg\installed\x64-windows-static"
          & C:\vcpkg\vcpkg.exe install ffmpeg[avcodec,avformat,swresample,swscale] libvpx libyuv opus aom --triplet x64-windows-static --classic
          
          # 关键修复：导出环境变量确保 Clang 能找到 Windows SDK
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: FRB Codegen
        shell: powershell
        run: |
          # 使用 1.80.1 版本匹配源代码结构
          cargo install flutter_rust_bridge_codegen --version 1.80.1
          
          # 生成桥接 Dart 代码
          flutter_rust_bridge_codegen `
            --rust-input src/flutter_ffi.rs `
            --rust-output src/bridge_generated.rs `
            --dart-output flutter/lib/generated_bridge.dart `
            --dart-decl-output flutter/lib/generated_bridge.freezed.dart `
            --skip-deps-check
          
          cd flutter
          flutter pub get
          # 必须执行生成 freezed 文件
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Patch UI & Fix Type Errors
        shell: powershell
        run: |
          # 1. 修复 Flutter 3.24+ 兼容性命名
          Get-ChildItem -Path "flutter/lib" -Recurse -Include *.dart | ForEach-Object {
              $t = Get-Content $_.FullName -Raw
              if ($t -match 'DialogTheme|TabBarTheme') {
                  $t = $t -replace 'DialogTheme\(', 'DialogThemeData(' `
                          -replace 'TabBarTheme\(', 'TabBarThemeData(' `
                          -replace 'DialogTheme\?', 'DialogThemeData?' `
                          -replace 'TabBarTheme\?', 'TabBarThemeData?'
                  [System.IO.File]::WriteAllText($_.FullName, $t, [System.Text.Encoding]::UTF8)
              }
          }

          # 2. 修复 FRB 产生的 bool vs NativeFunction 错误
          # 将错误的 == 运算符定义强行纠正回 bool
          $bridgeFile = "flutter/lib/generated_bridge.dart"
          if (Test-Path $bridgeFile) {
              $content = Get-Content $bridgeFile -Raw
              $content = $content -replace 'NativeFunction<Int Function\(Pointer<Int>\)> get ==', 'bool operator =='
              [System.IO.File]::WriteAllText($bridgeFile, $content, [System.Text.Encoding]::UTF8)
          }

      - name: Run Build
        shell: powershell
        run: |
          # 关键：手动指定 SDK 包含目录，解决 kcp-sys 找不到 stdlib.h 的问题
          $UCRT_PATH = "C:\Program Files (x86)\Windows Kits\10\Include\$env:UCRTVersion\ucrt"
          $MSVC_PATH = "$env:VCToolsInstallDir\include"
          $VCPKG_INC = "C:\vcpkg\installed\x64-windows-static\include"
          
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I`"$UCRT_PATH`" -I`"$MSVC_PATH`" -I`"$VCPKG_INC`""
          
          python build.py --flutter
          
          cd flutter
          flutter build windows --release --no-tree-shake-icons

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-x64
          path: flutter/build/windows/x64/runner/Release/
