name: Build-Windows-Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Install Build Tools
        run: |
          choco install llvm nasm ninja -y
          pip install requests

      - name: Setup VCPKG
        shell: powershell
        run: |
          & C:\vcpkg\vcpkg.exe install ffmpeg[avcodec,avformat,swresample,swscale] libvpx libyuv opus aom --triplet x64-windows-static --classic
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: Prepare Flutter & Dynamic FRB Codegen
        shell: powershell
        run: |
          cd flutter
          flutter pub get
          cd ..

          $pubspec = Get-Content flutter/pubspec.yaml -Raw
          if ($pubspec -match 'flutter_rust_bridge:\s*[\^~]?([0-9\.]+)') {
              $frbVersion = $Matches[1]
              Write-Host "Detected FRB Version: $frbVersion"
              cargo install flutter_rust_bridge_codegen --version $frbVersion
          } else {
              cargo install flutter_rust_bridge_codegen --version 1.80.1
          }

          flutter_rust_bridge_codegen `
            --rust-input src/flutter_ffi.rs `
            --rust-output src/bridge_generated.rs `
            --dart-output flutter/lib/generated_bridge.dart

          # 修复 Rust 符号冲突 (LNK2005)
          $rustBridge = "src/bridge_generated.rs"
          if (Test-Path $rustBridge) {
              $c = Get-Content $rustBridge -Raw
              $conflicts = @("store_dart_post_cobject","get_dart_object","drop_dart_object","new_dart_opaque","init_frb_dart_api_dl")
              foreach ($fn in $conflicts) {
                  $pattern = '(?s)#\[no_mangle\]\s+pub\s+unsafe\s+extern\s+"C"\s+fn\s+' + $fn + '\s*\(.*?\)\s*->?\s*.*?\s*\{.*?\}'
                  $c = $c -replace $pattern, "/* Removed $fn */"
              }
              $c = $c -replace 'Dart_Handle', 'isize'
              [System.IO.File]::WriteAllText($rustBridge, $c, [System.Text.Encoding]::UTF8)
          }

      - name: Fix Flutter 3.24 Compatibility (No-Destructive)
        shell: powershell
        run: |
          cd flutter
          # 1. 注入一个全局 Extension 来修复 ThemeData 缺失成员的问题，而不是改动业务代码
          $compatFiles = @"
          import 'package:flutter/material.dart';
          extension ThemeDataCompat on ThemeData {
            // 解决代码中通过 .TabBarThemeData 访问自定义主题的问题
            dynamic get TabBarThemeData => this.extension<dynamic>(); 
            dynamic get DialogThemeData => this.extension<dynamic>();
          }
          "@
          $compatFiles | Out-File -FilePath "lib/flutter_324_compat.dart" -Encoding UTF8

          # 2. 在 main.dart 中引用它
          $mainFile = "lib/main.dart"
          $mainContent = Get-Content $mainFile -Raw
          if ($mainContent -notmatch 'flutter_324_compat.dart') {
              "import 'flutter_324_compat.dart';`n" + $mainContent | Out-File -FilePath $mainFile -Encoding UTF8
          }

          # 3. 修正 common.dart 等文件中过时的参数名（精准修复）
          $commonFile = "lib/common.dart"
          if (Test-Path $commonFile) {
              (Get-Content $commonFile) -replace 'DialogTheme\(', 'DialogThemeData(' | Out-File $commonFile -Encoding UTF8
          }

          # 4. 运行 build_runner
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Final Build
        shell: powershell
        run: |
          $sdkVer = (Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include\10.*" | Sort-Object Name -Descending | Select-Object -First 1).Name
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I`"C:\Program Files (x86)\Windows Kits\10\Include\$sdkVer\ucrt`" -I`"C:\vcpkg\installed\x64-windows-static\include`""
          
          python build.py --flutter
          
          cd flutter
          # 针对老旧代码，使用最高容忍度编译
          flutter build windows --release --no-tree-shake-icons

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-x64
          path: flutter/build/windows/x64/runner/Release/
