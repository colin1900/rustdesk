name: Build-Windows-Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Install Build Tools
        run: |
          choco install llvm nasm ninja -y
          pip install requests

      - name: Setup VCPKG
        shell: powershell
        run: |
          $VcpkgInst = "C:\vcpkg\installed\x64-windows-static"
          & C:\vcpkg\vcpkg.exe install ffmpeg[avcodec,avformat,swresample,swscale] libvpx libyuv opus aom --triplet x64-windows-static --classic
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: FRB Codegen & Fix Rust Errors
        shell: powershell
        run: |
          cargo install flutter_rust_bridge_codegen --version 1.80.1
          
          # 生成桥接文件
          flutter_rust_bridge_codegen `
            --rust-input src/flutter_ffi.rs `
            --rust-output src/bridge_generated.rs `
            --dart-output flutter/lib/generated_bridge.dart `
            --skip-deps-check

          # 【关键修复 1】解决 Rust 找不到 Dart_Handle 的报错
          $rustBridge = "src/bridge_generated.rs"
          $rustContent = Get-Content $rustBridge -Raw
          $insertHeader = "use flutter_rust_bridge::support::Dart_Handle;`n"
          if ($rustContent -notmatch "use flutter_rust_bridge::support::Dart_Handle") {
              $insertHeader + $rustContent | Set-Content $rustBridge
          }

          cd flutter
          flutter pub get
          # 生成 freezed 文件
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Patch Flutter UI & Type Errors
        shell: powershell
        run: |
          # 【关键修复 2】修复 TabBarTheme 报错（解决 Getters can't be const 等）
          $tabBarFile = "flutter/lib/desktop/widgets/tabbar_widget.dart"
          if (Test-Path $tabBarFile) {
              $c = Get-Content $tabBarFile -Raw
              # 移除不合法的 const 关键字
              $c = $c -replace 'const TabbarTheme\(', 'TabbarTheme('
              # 将 TabbarTheme 转换为兼容新版 Flutter 的 Data 类名
              $c = $c -replace 'TabbarTheme', 'TabBarThemeData'
              Set-Content $tabBarFile $c
          }

          # 【关键修复 3】修复生成的 bridge 文件中的类型冲突
          $bridgeFile = "flutter/lib/generated_bridge.dart"
          if (Test-Path $bridgeFile) {
              $c = Get-Content $bridgeFile -Raw
              # 修复常见的类型映射错误
              $c = $c -replace 'NativeFunction<Int Function\(Pointer<Int>\)> get ==', 'bool operator =='
              Set-Content $bridgeFile $c
          }
          
          # 【强制兼容性】处理 DialogThemeData
          Get-ChildItem -Path "flutter/lib" -Filter "*.dart" -Recurse | ForEach-Object {
              (Get-Content $_.FullName) -replace 'DialogTheme\(', 'DialogThemeData(' | Set-Content $_.FullName
          }

      - name: Run Build
        shell: powershell
        run: |
          # 确保环境变量覆盖，解决 kcp-sys 的 stdlib 路径问题
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I`"C:\vcpkg\installed\x64-windows-static\include`""
          
          # 运行构建脚本
          python build.py --flutter
          
          cd flutter
          flutter build windows --release --no-tree-shake-icons

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Windows-x64
          path: flutter/build/windows/x64/runner/Release/
