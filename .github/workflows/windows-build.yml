name: Build-Windows-Portable-Official

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    permissions:
      contents: write # 允许上传到 Release
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Install Build Tools
        run: |
          choco install llvm nasm ninja rcedit -y
          pip install requests

      - name: Setup VCPKG
        shell: powershell
        run: |
          & C:\vcpkg\vcpkg.exe install ffmpeg[avcodec,avformat,swresample,swscale] libvpx libyuv opus aom --triplet x64-windows-static --classic
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: Generate Bridge Code
        shell: powershell
        run: |
          $pubspec = Get-Content flutter/pubspec.yaml -Raw
          $frbVersion = "1.80.1"
          if ($pubspec -match 'flutter_rust_bridge:\s*[\^~]?([0-9\.]+)') { $frbVersion = $Matches[1] }
          cargo install flutter_rust_bridge_codegen --version $frbVersion
          $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
          
          cd flutter
          flutter pub get
          cd ..
          flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --rust-output src/bridge_generated.rs --dart-output flutter/lib/generated_bridge.dart

          # 修复 LNK2005 重复符号冲突
          $rustBridge = "src/bridge_generated.rs"
          if (Test-Path $rustBridge) {
              $text = [System.IO.File]::ReadAllText($rustBridge)
              $conflicts = @("store_dart_post_cobject","get_dart_object","drop_dart_object","new_dart_opaque","init_frb_dart_api_dl")
              foreach ($fn in $conflicts) { 
                  $text = $text -replace "(?s)#\[no_mangle\]\s+pub\s+unsafe\s+extern\s+`"C`"\s+fn\s+$fn\s*\(.*?\)\s*->?\s*.*?\s*\{.*?\}", "/* Removed $fn */" 
              }
              $text = $text -replace 'Dart_Handle', 'isize'
              [System.IO.File]::WriteAllText($rustBridge, $text)
          }

      - name: Patch Flutter UI
        shell: powershell
        run: |
          $flutterDir = "$pwd/flutter"
          $compat = "import 'package:flutter/material.dart';`nextension ThemeDataCompat on ThemeData { dynamic get TabBarThemeData => this.tabBarTheme; dynamic get DialogThemeData => this.dialogTheme; }"
          $compat | Out-File -FilePath "$flutterDir/lib/flutter_324_compat.dart" -Encoding UTF8
          foreach ($file in @("lib/common.dart", "lib/main.dart")) {
              $path = Join-Path $flutterDir $file
              if (Test-Path $path) {
                  $c = Get-Content $path -Raw
                  if ($c -notmatch 'flutter_324_compat.dart') { $c = "import 'flutter_324_compat.dart';`n" + $c }
                  [System.IO.File]::WriteAllText($path, $c, [System.Text.Encoding]::UTF8)
              }
          }
          cd flutter
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build & Package (Portable)
        shell: powershell
        run: |
          $sdkVer = (Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Include\10.*" | Sort-Object Name -Descending | Select-Object -First 1).Name
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I`"C:\Program Files (x86)\Windows Kits\10\Include\$sdkVer\ucrt`" -I`"C:\vcpkg\installed\x64-windows-static\include`""
          
          python build.py --flutter
          
          # 将生成的安装包重命名为纯便携版名称
          $rawExe = Get-ChildItem "rustdesk-*.exe" | Select-Object -First 1
          if ($rawExe) {
              $date = Get-Date -Format "yyyyMMdd"
              $newName = "RustDesk-Portable-Windows-$date.exe"
              Copy-Item $rawExe.FullName $newName
              Write-Host "Portable file created: $newName"
              echo "FILE_NAME=$newName" >> $env:GITHUB_ENV
          } else {
              Write-Error "No EXE generated by build.py"
              exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Portable
          path: ${{ env.FILE_NAME }}

      - name: Release to GitHub
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: ${{ env.FILE_NAME }}
          tag_name: build-${{ github.run_number }}
          name: RustDesk Portable Build #${{ github.run_number }}
          body: |
            Automated Build for RustDesk Windows Portable.
            Version: 1.4.4 (Flutter 3.24)
            Date: ${{ env.GITHUB_ENV }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
